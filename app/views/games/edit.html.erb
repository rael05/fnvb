<h1>Editing game</h1>

<div class="px-3 py-2 border rounded-3">
  <%= form_with(model: @game) do |form| %>
    <% if @game.errors.any? %>
      <div style="color: red">
        <h2><%= pluralize(@game.errors.count, "error") %> prohibited this game from being saved:</h2>

        <ul>
          <% @game.errors.each do |error| %>
            <li><%= error.full_message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="mb-3 row">
      <div class="col">
        <%= form.label :winning_team, style: "display: block", class: "form-label" %>
        <%= form.select(:winning_team, options_for_select(@team_options, @winning_team), {}, class: "form-select") %>
      </div>

      <div class="col">
        <%= form.label :lose_team, style: "display: block", class: "form-label" %>
        <%= form.select(:lose_team, options_for_select(@team_options, @lose_team), {}, class: "form-select") %>
      </div>
    </div>

    <div class="mb-3 row">
      <div class="col">
        <%= form.label :win_score, style: "display: block", class: "form-label" %>
        <%= form.number_field :win_score, class: "form-control", min: 0 %>
      </div>

      <div class="col">
        <%= form.label :lose_score, style: "display: block", class: "form-label" %>
        <%= form.number_field :lose_score, class: "form-control", min: 0 %>
      </div>
    </div>

    <div class="mb-3">
      <%= form.label :description, style: "display: block", class: "form-label" %>
      <%= form.text_field :description, class: "form-control" %>
    </div>

    <div class="ms-0 row">
      <%= form.submit class: "btn btn-primary mb-2 col-2" %>
      <button type="button" class="btn btn-success ms-2 mb-2 col-3" data-bs-toggle="modal" data-bs-target="#exampleModal" data-bs-whatever="@mdo">
        Agregar Detalles de jugada
      </button>
    </div>
  <% end %>

  <!-- Modal -->
  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">Nuevo Registro de Jugada</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <%= form_with model: @gameDetail, url: "/games/game_details", method: :post do |form| %>
          <div class="modal-body py-0">
            <%=form.number_field :game_id, value: @game.id, class: "d-none"%>
            <div class="mb-3">
              <%= form.label :team_id, class: "col-form-label" %>
              <%= form.select(:team_id, options_for_select(@team_options), {}, class: "form-select") %>
            </div>
            <div class="mb-3">
              <%= form.label :player_id, class: "col-form-label" %>
              <%= form.select(:player_id, options_for_select(@payer_options), {}, class: "form-select") %>
            </div>
            <div class="mb-3">
              <%= form.label :detail_type, class: "col-form-label" %>
              <%= form.select(:detail_type, options_for_select(@detail_types), {}, class: "form-select") %>
            </div>
            <div class="mb-3">
              <%= form.label :number_set, class: "col-form-label" %>
              <%= form.number_field :number_set, class: "form-control", min: 1, max: 5 %>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <%= form.submit class: "btn btn-primary" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

</div>

<script>
  const selectWinning = document.getElementById("game_winning_team");
  const selectLose = document.getElementById("game_lose_team");
  const options1 = selectWinning.options[0].value;
  const options2 = selectWinning.options[1].value;

  selectWinning.addEventListener("change", function() {
    if (this.value == selectLose.value  && this.value == options1) {
      selectLose.value = options2;
    } else if (this.value == selectLose.value  && this.value == options2) {
      selectLose.value = options1;
    }
  });

  selectLose.addEventListener("change", function() {
    if (this.value == selectWinning.value && this.value == options1) {
      selectWinning.value = options2;
    } else if (this.value == selectWinning.value && this.value == options2) {
      selectWinning.value = options1;
    }
  });

  document.addEventListener("DOMContentLoaded", function() {
    const teamSelect = document.getElementById("game_detail_team_id");
    const playerSelect = document.getElementById("game_detail_player_id");

    teamSelect.addEventListener("change", function() {
      const teamId = this.value;
      if (!teamId) {
        playerSelect.innerHTML = "";
        return;
      }
      fetch(`/players/${teamId}/get_players`)
        .then(response => response.json())
        .then(data => {
          playerSelect.innerHTML = "";
          data.forEach(function(player) {
            const option = document.createElement("option");
            option.value = player.id;
            option.text = player.name;
            playerSelect.appendChild(option);
          });
        });
    });
  });
</script>

<br>

<div>
  <%= link_to "Show this game", @game %> |
  <%= link_to "Back to games", games_path %>
</div>
